<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GEO Watch</title>
  <link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Titillium+Web:wght@200&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
  <style>
    body {
      background-color: rgb(31, 29, 29);
      color:white;
      font-family: 'Titillium Web', sans-serif;
    }
    table {margin: auto;}
    tr {border: 1px solid #93c783;}
    td {padding: .25rem .5rem;border: 1px solid #93c783;}
    span.date {
      font-size: 10px;
    }

  </style>

  <div id="demo"></div>
  <table id="log">
    <thead>
      <tr class="timestamp">
        <th>Lat</th>
        <th>Long</th>
        <th>Distance</th>
        <th>Time</th>
      </tr>
    </thead>
  </table>
  <script>
    var x = document.getElementById("demo");
    var l = document.getElementById("log");
    var timed = document.querySelector('tr.timestamp')
    let latitude = '';
    let longitude = '';
    let altitude = '';
    let accuracy = '';
    let altitudeAccuracy = '';
    let speed = '';
    let heading = '';
    let time = "";
    let locationHistory = [];
    let previousTimestamp = [];
    let previousLatLong = [];
    let log = []
    let coordsDistance = '';
    let totalDistance = [];
    let distanceTraveled = 0;
    let milesTraveled = 0;
    function getLocation() {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(showPosition);
      } else {
        x.innerHTML = "Geolocation is not supported by this browser.";
      }
    }
    function showPosition(position) {
      
      timestamp = position.timestamp;
      latitude = position.coords.latitude;
      longitude = position.coords.longitude;
      altitude = position.coords.altitude;
      accuracy = position.coords.accuracy;
      altitudeAccuracy = position.coords.altitudeAccuracy;
      speedMPS = position.coords.speed;
      speedFPS = position.coords.speed * 3.28084;
      heading = position.coords.heading;
      
      if (locationHistory.length > 0) {
        previousLat = locationHistory[locationHistory.length-1]["coords"]["latitude"]
        previousLong = locationHistory[locationHistory.length-1]["coords"]["longitude"]
        previousTime = locationHistory[locationHistory.length-1]["timestamp"]
        previousLatLong = [{"Prev-Lat": previousLat, "Prev-Long" : previousLong, "Prev-Timestamp": previousTime}]
        currentLatLong = [{"Cur-Lat": latitude, "Cur-Long" : longitude, "Cur-Timestamp": timestamp}]
        coordsDistance = calcCrow(previousLat, previousLong, latitude, longitude)
        totalDistance.push(coordsDistance)
        function add(accumulator, a) {
          return accumulator + a;
        } 
        distanceTraveled =  totalDistance.reduce(add,0) * 10) 
        milesTraveled = distanceTraveled / 1.609;
        console.log(totalDistance)
    }
      
      locationHistory.push(position)
      log.push({
          "timestamp": timestamp,
          "latitude": latitude,
          "longitude": longitude,
          "speed": speed
      })

      x.innerHTML = `<b>Latitude:</b> ` + Math.round(latitude * 10) / 10 +
        "<div><b>Longitude:</b> " + Math.round(longitude * 10) / 10 +
        "</div><div><b>Altitude:</b> " + altitude +
        "</div><div><b>Accuracy:</b> " + accuracy +
        "</div><div><b>Speed - meters per second:</b> " + Math.round(speedMPS * 10) / 10 +
        "</div><div><b>Speed - feet per second:</b> " + Math.round(speedFPS * 10) / 10 +
        "</div><div><b>Heading:</b> " + heading + 
        "</div><div><b>Distance:</b> " + Math.round(distanceTraveled * 10) / 10 + " kilometers, or " + Math.round(milesTraveled * 10) / 10 + " miles</div>";

        var d = new Date(timestamp);

        
          timed.insertAdjacentHTML('afterEnd',`<tr class="timestamp" timestamp=` +timestamp+ `">` + 
          `<td class="lat">` + latitude + `</td>
          <td class="long">` + longitude + `</td> 
          <td class="distance">` + coordsDistance + `</td>
          <td class="timestamp"><div><span class="date">` + d.toLocaleDateString() + '</span><br>' + d.toLocaleTimeString() + '</td></tr>'
        )

    }


    //This function takes in latitude and longitude of two location and returns the distance between them as the crow flies (in km)
    function calcCrow(lat1, lon1, lat2, lon2) {
      var R = 6371; // km
      var dLat = toRad(lat2 - lat1);
      var dLon = toRad(lon2 - lon1);
      var lat1 = toRad(lat1);
      var lat2 = toRad(lat2);

      var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.sin(dLon / 2) * Math.sin(dLon / 2) * Math.cos(lat1) * Math.cos(lat2);
      var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      var d = R * c;
      return d;
    }

    // Converts numeric degrees to radians
    function toRad(Value) {
      return Value * Math.PI / 180;
    }


    getLocation({ maximumAge: 3000, timeout: 5000, enableHighAccuracy: true })
  </script>
</body>

</html>